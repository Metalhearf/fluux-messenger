app-id: com.processone.fluux
runtime: org.gnome.Platform
runtime-version: "47"
sdk: org.gnome.Sdk
command: fluux-messenger

finish-args:
  # Display
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=ipc

  # Network (required for XMPP)
  - --share=network

  # Audio (for notifications)
  - --socket=pulseaudio

  # Notifications
  - --talk-name=org.freedesktop.Notifications

  # System tray
  - --talk-name=org.kde.StatusNotifierWatcher

  # Secrets/Keyring (for storing credentials)
  - --talk-name=org.freedesktop.secrets

  # File access for file uploads/downloads
  - --filesystem=xdg-download

modules:
  - name: fluux
    buildsystem: simple
    build-commands:
      # Extract the deb package
      - ar x fluux.deb
      - tar xf data.tar.gz

      # Install binary
      - install -Dm755 usr/bin/fluux-messenger -t /app/bin/

      # Install desktop file
      - install -Dm644 usr/share/applications/fluux-messenger.desktop /app/share/applications/com.processone.fluux.desktop

      # Install icons
      - install -Dm644 usr/share/icons/hicolor/32x32/apps/fluux-messenger.png /app/share/icons/hicolor/32x32/apps/com.processone.fluux.png
      - install -Dm644 usr/share/icons/hicolor/128x128/apps/fluux-messenger.png /app/share/icons/hicolor/128x128/apps/com.processone.fluux.png
      - install -Dm644 usr/share/icons/hicolor/256x256@2/apps/fluux-messenger.png /app/share/icons/hicolor/256x256/apps/com.processone.fluux.png || true

      # Install metainfo
      - install -Dm644 com.processone.fluux.metainfo.xml /app/share/metainfo/com.processone.fluux.metainfo.xml

      # Update desktop file to use correct icon name and fix paths
      - sed -i 's|Icon=fluux-messenger|Icon=com.processone.fluux|g' /app/share/applications/com.processone.fluux.desktop
      - sed -i 's|Exec=fluux-messenger|Exec=fluux-messenger|g' /app/share/applications/com.processone.fluux.desktop

    sources:
      - type: file
        path: fluux.deb
      - type: file
        path: com.processone.fluux.metainfo.xml
